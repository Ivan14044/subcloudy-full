<template>
    <div v-if="pageStore.page && currentPageData" class="max-w-7xl mx-auto px-4 py-16 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="text-center mb-16">
            <h1 class="text-4xl font-light text-gray-900 dark:text-white mt-3">
                {{ currentPageData.title }}
            </h1>
        </div>

        <div class="content-page text-gray-900 dark:text-gray-300" v-html="currentPageData.content"></div>
    </div>
    <div v-else-if="isLoading" class="max-w-7xl mx-auto px-4 py-16 sm:px-6 lg:px-8 text-center">
        <div class="text-gray-500 dark:text-gray-400">????????????????...</div>
    </div>
    <div v-else class="max-w-7xl mx-auto px-4 py-16 sm:px-6 lg:px-8 text-center">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">???????????????? ???? ??????????????</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-4">?????????????????????????? ???????????????? ???? ????????????????????.</p>
        <router-link to="/" class="text-blue-500 hover:text-blue-600 underline">?????????????????? ???? ??????????????</router-link>
    </div>
</template>

<script setup lang="ts">
import { usePageStore } from '@/stores/pages';
import { useI18n } from 'vue-i18n';
import { onMounted, watch, computed, ref } from 'vue';
import { useRoute } from 'vue-router';
import { updateWebPageSEO } from '@/utils/seo';

const pageStore = usePageStore();
const { locale } = useI18n();
const route = useRoute();
const isLoading = ref(false);

// ???????????????? ???????????? ?????? ?????????????? ????????????
const currentPageData = computed(() => {
    console.log('[ContentPage] currentPageData computed, pageStore.page:', pageStore.page);
    if (!pageStore.page) {
        console.log('[ContentPage] No page in store');
        return null;
    }
    const currentLocale = locale.value;
    console.log('[ContentPage] Current locale:', currentLocale);
    // ?????????????? ???????????????? ???????????? ?????? ?????????????? ????????????, ???????? ?????? - ???????????????????? ru ?????? fallback
    const data = pageStore.page[currentLocale] || pageStore.page['ru'] || null;
    console.log('[ContentPage] Current page data:', data);
    return data;
});

function applySeo() {
    try {
        const data = currentPageData.value;
        if (!data) return;
        updateWebPageSEO({
            title: data.title,
            description: (data.content || '').replace(/<[^>]+>/g, '').slice(0, 220),
            canonical: window.location.pathname
        });
    } catch {}
}

async function loadPage() {
    console.log('[ContentPage] loadPage called, route.path:', route.path);
    isLoading.value = true;
    try {
        // ?????????????????? slug ???? ????????
        let slug = route.path.replace(/^\/|\/$/g, '');
        console.log('[ContentPage] Initial slug:', slug);
        const segments = slug.split('/').filter(Boolean);
        console.log('[ContentPage] Segments:', segments);
        
        // ???????? ???????????? ?????????????? - ?????? ????????????, ?????????????? ??????
        const SUPPORTED_LOCALES = ['ru', 'uk', 'en', 'es', 'zh'];
        if (segments.length > 0 && SUPPORTED_LOCALES.includes(segments[0])) {
            console.log('[ContentPage] Removing locale:', segments[0]);
            segments.shift();
            slug = segments.join('/');
        }
        console.log('[ContentPage] Final slug:', slug);
        console.log('[ContentPage] Current locale:', locale.value);
        
        // ?????????????????? ???????????? ??????????????
        console.log('[ContentPage] Fetching pages data...');
        await pageStore.fetchData(locale.value);
        console.log('[ContentPage] Pages loaded, available slugs:', Object.keys(pageStore.pages));
        console.log('[ContentPage] Pages data:', pageStore.pages);
        
        // ?????????????????????????? ?????????????? ????????????????
        if (slug && pageStore.pages[slug]) {
            console.log('[ContentPage] Setting page for slug:', slug);
            console.log('[ContentPage] Page data:', pageStore.pages[slug]);
            pageStore.setPage(pageStore.pages[slug]);
            console.log('[ContentPage] Page set, pageStore.page:', pageStore.page);
        } else {
            console.warn(`[ContentPage] Page not found for slug: "${slug}"`);
            console.warn(`[ContentPage] Available slugs:`, Object.keys(pageStore.pages));
            pageStore.setPage(null);
        }
        
        applySeo();
    } catch (error) {
        console.error('[ContentPage] Error loading page:', error);
        console.error('[ContentPage] Error stack:', error.stack);
        pageStore.setPage(null);
    } finally {
        isLoading.value = false;
        console.log('[ContentPage] loadPage finished, isLoading:', isLoading.value);
    }
}

onMounted(() => {
    loadPage();
});

// ?????????????????????? ?????????????????? ????????????????
watch(() => route.path, () => {
    loadPage();
});

watch(() => locale.value, () => {
    loadPage();
});

watch(() => pageStore.page, () => {
    applySeo();
});
</script>

<style scoped>
/* ?????????? ?????? ???????????????????? ?????????????? */
.content-page {
    line-height: 1.8;
}

/* ???????????????????????????? ?????????? ???????? ???????????? ?? HTML ???????????????? ?????? ?????????????? ???????? */
.content-page :deep(p),
.content-page :deep(div),
.content-page :deep(span),
.content-page :deep(li),
.content-page :deep(td),
.content-page :deep(th) {
    color: inherit;
}

.content-page :deep(h1),
.content-page :deep(h2),
.content-page :deep(h3),
.content-page :deep(h4),
.content-page :deep(h5),
.content-page :deep(h6) {
    color: rgb(17, 24, 39); /* gray-900 */
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.dark .content-page :deep(h1),
.dark .content-page :deep(h2),
.dark .content-page :deep(h3),
.dark .content-page :deep(h4),
.dark .content-page :deep(h5),
.dark .content-page :deep(h6) {
    color: rgb(209, 213, 219); /* gray-300 */
}

/* ?????????????? ?????????? ???????? ???? ???????????????????? ???????????? ???? ?????????????? ???????? */
.content-page :deep([style*="color: white"]),
.content-page :deep([style*="color:#fff"]),
.content-page :deep([style*="color:#ffffff"]),
.content-page :deep([style*="color: rgb(255, 255, 255)"]),
.content-page :deep([style*="color: rgb(255,255,255)"]) {
    color: rgb(17, 24, 39) !important; /* gray-900 */
}

.dark .content-page :deep([style*="color: white"]),
.dark .content-page :deep([style*="color:#fff"]),
.dark .content-page :deep([style*="color:#ffffff"]),
.dark .content-page :deep([style*="color: rgb(255, 255, 255)"]),
.dark .content-page :deep([style*="color: rgb(255,255,255)"]) {
    color: rgb(209, 213, 219) !important; /* gray-300 */
}

/* ?????????? ?????? ???????????? */
.content-page :deep(a) {
    color: rgb(59, 130, 246); /* blue-500 */
    text-decoration: underline;
}

.content-page :deep(a:hover) {
    color: rgb(37, 99, 235); /* blue-600 */
}

.dark .content-page :deep(a) {
    color: rgb(96, 165, 250); /* blue-400 */
}

.dark .content-page :deep(a:hover) {
    color: rgb(147, 197, 253); /* blue-300 */
}

/* ?????????? ?????? ?????????????? */
.content-page :deep(ul),
.content-page :deep(ol) {
    margin-left: 1.5rem;
    margin-top: 1rem;
    margin-bottom: 1rem;
}

.content-page :deep(li) {
    margin-bottom: 0.5rem;
}
</style>
