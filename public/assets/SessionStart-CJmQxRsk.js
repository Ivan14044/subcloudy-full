import{k as t,d as e,r as i,E as s,o as n,j as l,l as a,m as o,t as r}from"./vendor-vue-hI7Tl2YZ.js";import{g as u,u as d,c,h as p}from"./index-CY44GJdZ.js";import"./vendor-i18n-DgmEITMB.js";import"./vendor-ui-C1W_zwwL.js";const h=t("browserSessions",{state:()=>({url:null,pid:null,port:null}),actions:{async startSession(t,e,i){var s,n;try{const l=(null==(n=null==(s=d().user)?void 0:s.extension_settings)?void 0:n.uiLanguage)||"en",a=await u.get("/browser/new",{params:{service_id:t??void 0,uiLanguage:l,...void 0!==e&&{width:e},...void 0!==i&&{height:i}}}),{pid:o,port:r,url:c}=a.data;return this.pid=o,this.port=r,this.url=c,{pid:o,port:r,url:c}}catch(l){return null}},async stopSession(t){const e="number"==typeof t?t:this.pid;if(e)try{await u.post("/browser/stop",{pid:e}),this.pid===e&&(this.pid=null,this.port=null,this.url=null)}catch(i){}},async stopSessionByPort(t){const e="number"==typeof t?t:this.port;if(e)try{await u.post("/browser/stop",{port:e}),this.port===e&&(this.pid=null,this.port=null,this.url=null)}catch(i){}},async stopAllSessions(t=!1){try{await u.post("/browser/stop_all",t?{clean:!0}:{}),this.pid=null,this.port=null,this.url=null}catch(e){}},async listSessions(){try{return(await u.get("/browser/list")).data}catch(t){return null}}}}),w={class:"fixed inset-0"},v=["src"],m=e({__name:"SessionStart",setup(t){const e=i(null),u=i(!1),m=i(!1),g=s(),y=h(),f=d(),b=c(),{checkPluginInstalled:S}=p();let x=null,E=null;n(async()=>{const t=(()=>{const t=g.params.id,e=t?Number(t):NaN;return Number.isFinite(e)?e:null})();await b.fetchData();(await S()).isInstalled?(u.value=!0,k(t)):(E=e=>{const{pluginInstalled:i,pluginSkipped:s}=e.detail||{};(i||s)&&(u.value=!0,k(t))},window.addEventListener("app:plugin-status",E),window.dispatchEvent(new CustomEvent("app:check-plugin-status")))});const k=async t=>{if(u.value&&!m.value&&!e.value)try{m.value=!0;const i={width:window.innerWidth,height:window.innerHeight},s=Math.max(360,Math.min(2560,i.width)),n=Math.max(600,Math.min(1440,i.height)),l=await y.startSession(t,s,n);if(!l)return void(m.value=!1);e.value=l.url,x=window.setTimeout(()=>{window.dispatchEvent(new CustomEvent("app:hide-loader"));const e=t?b.getById(t):void 0,i=null==e?void 0:e.params;if((null==i?void 0:i.title)&&"string"==typeof i.title&&i.title.length>0&&(document.title=i.title),(null==i?void 0:i.icon)&&"string"==typeof i.icon&&i.icon.length>0){const t=i.icon,e=/^https?:\/\//i.test(t)?t:`${"subcloudy.com"}${t}`,s=e.endsWith(".ico")?"image/x-icon":"image/png";((t,e)=>{let i=document.querySelector("link[rel='icon']");i||(i=document.createElement("link"),i.rel="icon",document.head.appendChild(i)),i.type=e,i.href=t})(e,s)}},5250),f.update({browser_session_pid:l.pid}).catch(t=>{})}catch(i){m.value=!1}};return l(()=>{null!==x&&(clearTimeout(x),x=null),E&&(window.removeEventListener("app:plugin-status",E),E=null)}),(t,i)=>(o(),a("div",w,[e.value?(o(),a("iframe",{key:0,src:e.value,class:"fixed inset-0 w-screen h-screen",style:{border:"0"}},null,8,v)):r("",!0)]))}});export{m as default};
